<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="scripts">

    
    <script src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.11.0/browser/overlayscrollbars.browser.es6.min.js"
        crossorigin="anonymous"></script>
    <!--end::Third Party Plugin(OverlayScrollbars)--><!--begin::Required Plugin(popperjs for Bootstrap 5)-->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        crossorigin="anonymous"></script>
    <!--end::Required Plugin(popperjs for Bootstrap 5)--><!--begin::Required Plugin(Bootstrap 5)-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"
        crossorigin="anonymous"></script>
    <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
    <script th:src="@{/js/adminlte.js}"></script>
    <!--end::Required Plugin(AdminLTE)--><!--begin::OverlayScrollbars Configure-->
    <script>
        const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
        const Default = {
            scrollbarTheme: 'os-theme-light',
            scrollbarAutoHide: 'leave',
            scrollbarClickScroll: true,
        };
        document.addEventListener('DOMContentLoaded', function () {
            const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
            if (sidebarWrapper && OverlayScrollbarsGlobal?.OverlayScrollbars !== undefined) {
                OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                    scrollbars: {
                        theme: Default.scrollbarTheme,
                        autoHide: Default.scrollbarAutoHide,
                        clickScroll: Default.scrollbarClickScroll,
                    },
                });
            }
        });
    </script>
    <!--end::OverlayScrollbars Configure--><!-- Image path runtime fix -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Find the link tag for the main AdminLTE CSS file.
            const cssLink = document.querySelector('link[href*="css/adminlte.css"]');
            if (!cssLink) {
                return; // Exit if the link isn't found
            }

            // Extract the base path from the CSS href.
            // e.g., from "../css/adminlte.css", we get "../"
            // e.g., from "./css/adminlte.css", we get "./"
            const cssHref = cssLink.getAttribute('href');
            const deploymentPath = cssHref.slice(0, cssHref.indexOf('@{/adminlte.css}'));

            // Find all images with absolute paths and fix them.
            document.querySelectorAll('@{img[src^="/assets/"]}').forEach((img) => {
                const originalSrc = img.getAttribute('src');
                if (originalSrc) {
                    const relativeSrc = originalSrc.slice(1); // Remove leading '/'
                    img.src = deploymentPath + relativeSrc;
                }
            });
        });
    </script>
    <!-- OPTIONAL SCRIPTS -->
    <!-- apexcharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js"
        integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>
    <script>
        // NOTICE!! DO NOT USE ANY OF THIS JAVASCRIPT
        // IT'S ALL JUST JUNK FOR DEMO
        // ++++++++++++++++++++++++++++++++++++++++++

        /* apexcharts
         * -------
         * Here we will create a few charts using apexcharts
         */

        //-----------------------
        // - MONTHLY SALES CHART -
        //-----------------------

        const sales_chart_options = {
            series: [
                {
                    name: 'Digital Goods',
                    data: [28, 48, 40, 19, 86, 27, 90],
                },
                {
                    name: 'Electronics',
                    data: [65, 59, 80, 81, 56, 55, 40],
                },
            ],
            chart: {
                height: 180,
                type: 'area',
                toolbar: {
                    show: false,
                },
            },
            legend: {
                show: false,
            },
            colors: ['#0d6efd', '#20c997'],
            dataLabels: {
                enabled: false,
            },
            stroke: {
                curve: 'smooth',
            },
            xaxis: {
                type: 'datetime',
                categories: [
                    '2023-01-01',
                    '2023-02-01',
                    '2023-03-01',
                    '2023-04-01',
                    '2023-05-01',
                    '2023-06-01',
                    '2023-07-01',
                ],
            },
            tooltip: {
                x: {
                    format: 'MMMM yyyy',
                },
            },
        };

        const sales_chart = new ApexCharts(
            document.querySelector('#sales-chart'),
            sales_chart_options,
        );
        sales_chart.render();

        //---------------------------
        // - END MONTHLY SALES CHART -
        //---------------------------

        function createSparklineChart(selector, data) {
            const options = {
                series: [{ data }],
                chart: {
                    type: 'line',
                    width: 150,
                    height: 30,
                    sparkline: {
                        enabled: true,
                    },
                },
                colors: ['var(--bs-primary)'],
                stroke: {
                    width: 2,
                },
                tooltip: {
                    fixed: {
                        enabled: false,
                    },
                    x: {
                        show: false,
                    },
                    y: {
                        title: {
                            formatter() {
                                return '';
                            },
                        },
                    },
                    marker: {
                        show: false,
                    },
                },
            };

            const chart = new ApexCharts(document.querySelector(selector), options);
            chart.render();
        }

        const table_sparkline_1_data = [25, 66, 41, 89, 63, 25, 44, 12, 36, 9, 54];
        const table_sparkline_2_data = [12, 56, 21, 39, 73, 45, 64, 52, 36, 59, 44];
        const table_sparkline_3_data = [15, 46, 21, 59, 33, 15, 34, 42, 56, 19, 64];
        const table_sparkline_4_data = [30, 56, 31, 69, 43, 35, 24, 32, 46, 29, 64];
        const table_sparkline_5_data = [20, 76, 51, 79, 53, 35, 54, 22, 36, 49, 64];
        const table_sparkline_6_data = [5, 36, 11, 69, 23, 15, 14, 42, 26, 19, 44];
        const table_sparkline_7_data = [12, 56, 21, 39, 73, 45, 64, 52, 36, 59, 74];

        createSparklineChart('#table-sparkline-1', table_sparkline_1_data);
        createSparklineChart('#table-sparkline-2', table_sparkline_2_data);
        createSparklineChart('#table-sparkline-3', table_sparkline_3_data);
        createSparklineChart('#table-sparkline-4', table_sparkline_4_data);
        createSparklineChart('#table-sparkline-5', table_sparkline_5_data);
        createSparklineChart('#table-sparkline-6', table_sparkline_6_data);
        createSparklineChart('#table-sparkline-7', table_sparkline_7_data);

        //-------------
        // - PIE CHART -
        //-------------

        const pie_chart_options = {
            series: [700, 500, 400, 600, 300, 100],
            chart: {
                type: 'donut',
            },
            labels: ['Chrome', 'Edge', 'FireFox', 'Safari', 'Opera', 'IE'],
            dataLabels: {
                enabled: false,
            },
            colors: ['#0d6efd', '#20c997', '#ffc107', '#d63384', '#6f42c1', '#adb5bd'],
        };

        const pie_chart = new ApexCharts(document.querySelector('#pie-chart'), pie_chart_options);
        pie_chart.render();

        //-----------------
        // - END PIE CHART -
        //-----------------
    </script>
    <!--end::Script-->

    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <script sec:authorize="isAuthenticated()">
        document.addEventListener('DOMContentLoaded', function () {
            const notificationBadge = document.getElementById('notification-badge');
            const notificationList = document.getElementById('notification-list');
            const notificationBell = document.getElementById('notificationBell');
            const csrfTokenEl = document.querySelector('meta[name="_csrf"]');
            const csrfHeaderEl = document.querySelector('meta[name="_csrf_header"]');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function () {
                    document.querySelector('.wrapper').classList.toggle('sidebar-collapsed');
                });
            }

            async function fetchUnreadCount() {
                try {
                    const response = await fetch('/api/notifications/unread-count');
                    if (!response.ok) return;
                    const data = await response.json();

                    if (data.count > 0) {
                        notificationBadge.innerText = data.count > 9 ? '9+' : data.count;
                        notificationBadge.style.display = 'block';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Gagal mengambil jumlah notifikasi:', error);
                }
            }

            async function fetchNotifications() {
                try {
                    const response = await fetch('/api/notifications');
                    if (!response.ok) return;
                    const notifications = await response.json();

                    notificationList.innerHTML = '';

                    if (notifications.length === 0) {
                        const emptyItem = `<li><div class="dropdown-item text-center text-light fst-italic">Tidak ada notifikasi.</div></li>`;
                        notificationList.insertAdjacentHTML('beforeend', emptyItem);
                        return;
                    }

                    notifications.forEach(notif => {
                        // PERBAIKAN DILAKUKAN DI SINI
                        const item = `
                            <li class="list-group-item list-group-item-dark p-3 border-0 border-bottom border-secondary notification-item">
                                <div class="d-flex w-100">
                                    <div class="me-3 align-self-center">
                                        <i class="fas ${!notif.read ? 'fa-envelope-open-text' : 'fa-envelope'} text-info fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <a href="${notif.link || '#'}" class="text-decoration-none text-white stretched-link">
                                            <p class="mb-1 message-content ${!notif.read ? 'fw-bold' : ''}">
                                                ${notif.message}
                                            </p>
                                        </a>
                                        <small class="d-block text-cyan-50">
                                            <i class="far fa-clock me-1"></i>${new Date(notif.createdAt).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}
                                        </small>
                                    </div>
                                    <div class="ms-2 align-self-center" style="position: relative; z-index: 1;">
                                        <button class="btn btn-sm btn-outline-danger border-0 delete-notification-btn" data-id="${notif.id}" title="Hapus Notifikasi">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </li>`;
                        notificationList.insertAdjacentHTML('beforeend', item);
                    });

                    const footer = `
                        <li class="bg-dark">
                            <div class="text-center py-2">
                                <button class="btn btn-danger btn-sm" id="delete-all-notifications-btn">
                                    <i class="fas fa-broom me-1"></i> Hapus Semua
                                </button>
                            </div>
                        </li>`;
                    notificationList.insertAdjacentHTML('beforeend', footer);

                } catch (error) {
                    console.error('Gagal mengambil daftar notifikasi:', error);
                    notificationList.innerHTML = '<li><div class="dropdown-item text-center text-danger">Gagal memuat notifikasi.</div></li>';
                }
            }

            async function markAsRead() {
                try {
                    const fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    };
                    if (csrfTokenEl && csrfHeaderEl) {
                        fetchOptions.headers[csrfHeaderEl.content] = csrfTokenEl.content;
                    }
                    await fetch('/api/notifications/mark-as-read', fetchOptions);
                    notificationBadge.style.display = 'none';
                } catch (error) {
                    console.error('Gagal menandai notifikasi sebagai terbaca:', error);
                }
            }

            async function deleteNotification(id, element) {
                try {
                    const fetchOptions = {
                        method: 'DELETE',
                        headers: {}
                    };
                    if (csrfTokenEl && csrfHeaderEl) {
                        fetchOptions.headers[csrfHeaderEl.content] = csrfTokenEl.content;
                    }
                    const response = await fetch(`/api/notifications/${id}`, fetchOptions);

                    if (response.ok) {
                        element.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        element.style.opacity = '0';
                        element.style.transform = 'translateX(20px)';
                        setTimeout(() => {
                            element.remove();
                            if (notificationList.querySelectorAll('.notification-item').length === 0) {
                                fetchNotifications();
                            }
                        }, 300);
                    } else {
                        alert('Gagal menghapus notifikasi.');
                    }
                } catch (error) {
                    console.error('Error saat menghapus notifikasi:', error);
                }
            }


            async function deleteAllNotifications() {
                if (!confirm('Apakah Anda yakin ingin menghapus SEMUA notifikasi? Aksi ini tidak dapat dibatalkan.')) {
                    return;
                }
                try {
                    const fetchOptions = {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    };
                    if (csrfTokenEl && csrfHeaderEl) {
                        fetchOptions.headers[csrfHeaderEl.content] = csrfTokenEl.content;
                    }
                    const response = await fetch('/api/notifications/delete-all', fetchOptions);

                    if (response.ok) {
                        notificationList.innerHTML = '<li><div class="dropdown-item text-center text-light fst-italic">Tidak ada notifikasi.</div></li>';
                        fetchUnreadCount();
                    } else {
                        alert('Gagal menghapus notifikasi di server.');
                    }
                } catch (error) {
                    console.error('Error saat menghapus semua notifikasi:', error);
                    alert('Terjadi kesalahan koneksi saat menghapus notifikasi.');
                }
            }

            notificationList.addEventListener('click', function (event) {
                const deleteButton = event.target.closest('.delete-notification-btn');
                const deleteAllButton = event.target.closest('#delete-all-notifications-btn');

                if (deleteButton) {
                    event.stopPropagation();
                    const notifId = deleteButton.dataset.id;
                    const notifElement = deleteButton.closest('li.notification-item');
                    deleteNotification(notifId, notifElement);
                }

                if (deleteAllButton) {
                    event.stopPropagation();
                    deleteAllNotifications();
                }
            });

            notificationBell.addEventListener('show.bs.dropdown', async function () {
                await fetchNotifications();
                await markAsRead();
            });

            fetchUnreadCount();
            setInterval(fetchUnreadCount, 5000);
        });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const sidebarWrapper = document.querySelector('.sidebar-wrapper');
        if (sidebarWrapper) {
          OverlayScrollbars(sidebarWrapper, {
            scrollbars: {
              theme: 'os-theme-light',
              autoHide: 'leave',
              clickScroll: true,
            },
          });
        }
      });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.min.js" integrity="sha256-+vh8GkaU7C9/wbSLIcwq82tQ2wTf44aOHA8HlBMwRI8=" crossorigin="anonymous"></script>
</div>
</body>
</html>